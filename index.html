<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تحضير الطلاب / لوحة المعلّم</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="madina">
  <div class="brand">
    <img src="logo.PNG" class="logo" alt="شعار حلقات المسجد النبوي">
    <h1>حلقة المعلمة فطومة / الفجر</h1>
    <p class="subtitle">لحفظ القرآن الكريم والمتون العلمية</p>
  </div>
</header>

<main>
    <div class="card toolbar">
    <div>
      <span class="muted">الوقت الآن (مكة): </span><span id="now" class="badge">--:--:--</span>
      <span id="gate" class="badge" style="margin-inline-start:8px">الحالة: —</span>
    </div>
    <div class="row">
      <button id="btnShowLogin" class="btn alt">دخول المعلّم</button>
      <button id="btnLogout" class="btn" style="display:none;background:#b34b57">خروج</button>
    </div>
  </div>

    <section id="student-form" class="card">
    <h2>تحضير الطالب</h2>
    <form id="form" autocomplete="off" class="form-grid">
      <div class="form-group">
        <label>١) اسم الطالب</label>
        <input id="name" required placeholder="مثال: أحمد بن خالد"/>
      </div>
      <div class="form-group">
        <label>٢) مقدار الحفظ</label>
        <input id="hifz" required placeholder="مثال: سورة الكهف ١–١١"/>
      </div>
      <div class="form-group">
        <label>٣) المراجعة</label>
        <input id="mur" required placeholder="مثال: نصف جزء عم"/>
      </div>
      <div class="form-group">
        <label>٤) هل تم الاستماع إلى الشيخ؟</label>
        <div class="switch">
          <label><input type="radio" name="listened" value="نعم" required> نعم</label>
          <label><input type="radio" name="listened" value="لا"> لا</label>
        </div>
      </div>
      <div class="form-group full-width">
        <label>ملاحظات (اختياري)</label>
        <textarea id="notes" placeholder="أي ملاحظات للمعلم…"></textarea>
      </div>
      <div class="row" style="margin-top:12px; grid-column: 1 / -1;">
        <button type="submit" class="btn">إرسال للمعلّم</button>
        <span id="ok" class="muted" style="color:#23935c;display:none">تم الحفظ بنجاح</span>
        <span id="err" class="muted" style="color:#c0392b;display:none"></span>
      </div>
      <p class="muted" style="margin:10px 0 0">النافذة المسموحة: ٤:٠٠–٦:٠٠ فجراً (بتوقيت مكة)</p>
    </form>
  </section>

    <section id="login-box" class="card">
    <h2>تسجيل دخول المعلّم</h2>
    <div class="row">
      <input id="email" type="email" placeholder="بريد المعلّم">
      <input id="password" type="password" placeholder="كلمة المرور">
      <button id="btnLogin" class="btn alt">دخول</button>
      </div>
    <div id="lerr" class="muted" style="color:#c0392b;margin-top:8px"></div>
  </section>

    <section id="teacher-panel" class="card">
    <h2>لوحة المعلّم</h2>
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="row">
        <label>من: <input id="from" type="date"></label>
        <label>إلى: <input id="to" type="date"></label>
        <button id="btnFilter" class="btn alt">تصفية</button>
        <button id="btnToday" class="btn gray">اليوم</button>
        <button id="btnLast7" class="btn gray">آخر 7 أيام</button>
      </div>
      <div class="row">
        <button id="btnExport" class="btn green">تصدير CSV</button>
      </div>
    </div>
    <p class="muted" id="count"></p>
    <div style="overflow:auto;max-height:70vh">
      <table id="tbl">
        <thead>
          <tr><th>التاريخ (مكة)</th><th>الاسم</th><th>الحفظ</th><th>المراجعة</th><th>الاستماع</th><th>ملاحظات</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<script>
/* ==== استبدلي بقيم مشروعك في Supabase ==== */
const SUPABASE_URL       = 'https://pgroyirpumfnqgesmdhs.supabase.co';      // Project URL
const SUPABASE_ANON_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBncm95aXJwdW1mbnFnZXNtZGhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzgxNjUsImV4cCI6MjA3MzIxNDE2NX0.nFMHjwDyIgT140by2o6Y-N38Iugl6lImIGUM7fZARF4';          // anon public key
/* ========================================== */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* الوقت بتوقيت مكة + نافذة 4-6 فجراً */
const TZ='Asia/Riyadh', START_H=4, END_H=6;
function nowStr(){return new Intl.DateTimeFormat('ar-SA',{timeZone:TZ,hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());}
function hourKSA(){return parseInt(new Intl.DateTimeFormat('en-GB',{timeZone:TZ,hour12:false,hour:'2-digit'}).format(new Date()),10);}
function isOpen(){const h=hourKSA(); return h>=START_H && h<END_H;}
const $now=document.getElementById('now'), $gate=document.getElementById('gate');
setInterval(()=>{ $now.textContent=nowStr(); $gate.textContent='الحالة: '+(isOpen()?'مفتوح':'مغلق'); },1000);

/* عناصر الواجهة */
const $studentForm=document.getElementById('student-form');
const $loginBox=document.getElementById('login-box');
const $teacher=document.getElementById('teacher-panel');
const $btnShowLogin=document.getElementById('btnShowLogin');
const $btnLogout=document.getElementById('btnLogout');

/* إظهار صندوق دخول المعلّم */
$btnShowLogin.onclick=()=>{ $loginBox.style.display='block'; window.scrollTo({top:$loginBox.offsetTop,behavior:'smooth'}); };

/* دخول/خروج المعلّم */
document.getElementById('btnLogin').onclick = async ()=>{
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const {error}=await sb.auth.signInWithPassword({email,password});
  const lerr=document.getElementById('lerr');
  if(error){ lerr.textContent=error.message; return; }
  lerr.textContent=''; onTeacherSignedIn();
};
$btnLogout.onclick = async ()=>{ await sb.auth.signOut(); onTeacherSignedOut(); };

function onTeacherSignedIn(){
  $studentForm.style.display='none';
  $loginBox.style.display='none';
  $teacher.style.display='block';
  $btnLogout.style.display='inline-flex';
  loadRows();
}
function onTeacherSignedOut(){
  $studentForm.style.display='block';
  $loginBox.style.display='none';
  $teacher.style.display='none';
  $btnLogout.style.display='none';
}

/* التحقق من جلسة حالية */
sb.auth.getSession().then(({data})=>{
  if(data.session){ onTeacherSignedIn(); } else { onTeacherSignedOut(); }
});

/* إرسال الطالب */
document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const ok=document.getElementById('ok'), err=document.getElementById('err'); ok.style.display='none'; err.style.display='none';
  if(!isOpen()){ err.textContent='النموذج يعمل فقط ٤–٦ فجراً (بتوقيت مكة).'; err.style.display='inline'; return; }
  const name=document.getElementById('name').value.trim();
  const hifz=document.getElementById('hifz').value.trim();
  const mur =document.getElementById('mur').value.trim();
  const notes=document.getElementById('notes').value.trim();
  const listened=((new FormData(e.target)).get('listened')==='نعم');
  if(!name||!hifz||!mur){ err.textContent='أكمل الحقول المطلوبة.'; err.style.display='inline'; return; }
  const { error } = await sb.from('attendance').insert([{ name,hifz,mur,listened,notes }]);
  if(error){ err.textContent='تعذّر الإرسال: '+error.message; err.style.display='inline'; }
  else { ok.style.display='inline'; e.target.reset(); }
});

/* لوحة المعلّم: قراءة/تصفية/تصدير */
function ksa(dt){ return new Date(dt).toLocaleString('ar-SA',{timeZone:TZ,hour12:false}); }
async function loadRows(range){
  let q = sb.from('attendance').select('*').order('created_at',{ascending:false});
  if(range?.from){ q=q.gte('created_at', range.from+'T00:00:00Z'); }
  if(range?.to){   q=q.lte('created_at', range.to  +'T23:59:59Z'); }
  const { data, error } = await q; if(error){ alert('تعذّر الجلب: '+error.message); return; }
  document.getElementById('count').textContent=`عدد السجلات: ${data.length}`;
  const tbody=document.querySelector('#tbl tbody');
  tbody.innerHTML=data.map(r=>`
    <tr><td>${ksa(r.created_at)}</td><td>${esc(r.name)}</td><td>${esc(r.hifz)}</td>
        <td>${esc(r.mur)}</td><td>${r.listened?'نعم':'لا'}</td><td>${esc(r.notes||'')}</td></tr>
  `).join('');
  window.__rows=data;
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

document.getElementById('btnFilter').onclick = ()=>{
  const from=document.getElementById('from').value || null;
  const to  =document.getElementById('to').value   || null;
  loadRows({from,to});
};
document.getElementById('btnToday').onclick = ()=>{
  const t=new Date().toISOString().slice(0,10);
  document.getElementById('from').value=t; document.getElementById('to').value=t;
  loadRows({from:t,to:t});
};
document.getElementById('btnLast7').onclick = ()=>{
  const to=new Date(); const from=new Date(Date.now()-6*86400000);
  const s=d=>d.toISOString().slice(0,10);
  document.getElementById('from').value=s(from); document.getElementById('to').value=s(to);
  loadRows({from:s(from),to:s(to)});
};
document.getElementById('btnExport').onclick = ()=>{
  const rows=(window.__rows||[]).map(r=>[ksa(r.created_at),r.name,r.hifz,r.mur,r.listened?'نعم':'لا',r.notes||'']);
  const header=['التاريخ','الاسم','الحفظ','المراجعة','الاستماع','الملاحظات'];
  const csv=[header,...rows].map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='attendance.csv'; a.click();
};
</script>
</body>
</html>
