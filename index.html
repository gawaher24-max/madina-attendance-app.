<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تحضير الطلاب / لوحة المعلّم</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    /* لوحة الأخضر (قابلة للتعديل) */
    --green-900:#0b3d2e; /* أخضر داكن جداً */
    --green-800:#114d37;
    --green-700:#166241;
    --green-600:#1b7a4e; /* يقترب من الصورة */
    --green-400:#4ea77f;
    --green-200:#bfe3cf;
    --paper:#ffffff; --bg:#f3f6f4; --text:#1b1b1b; --muted:#6b6b6b;
    --accent:#1b7a4e; --shadow:0 10px 28px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",sans-serif}
  header.madina{
    text-align:center;color:#fff;padding:18px 12px 22px;
    background: linear-gradient(180deg,var(--green-700),var(--green-600) 55%, var(--green-400));
    border-bottom:6px solid var(--green-900);
    position:relative; overflow:hidden;
  }
  header.madina::after{
    content:""; position:absolute; inset:-30% -10% auto -10%;
    height:240px; background:radial-gradient(70% 60% at 50% 20%, rgba(255,255,255,.18), transparent 60%);
    pointer-events:none;
  }
  .brand{display:flex; flex-direction:column; align-items:center; gap:10px}
  .brand img.logo{max-height:110px; width:auto; filter: drop-shadow(0 6px 16px rgba(0,0,0,.25));}
  .brand h1{font-family:"Amiri",serif; margin:0; font-size:28px; letter-spacing:.3px}
  .brand .subtitle{margin:2px 0 0; color:#e9f6ef}

  main{max-width:1100px;margin:22px auto;padding:0 12px}
  .card{background:var(--paper); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; margin-bottom:16px}
  h2{margin:0 0 10px; font-weight:800; letter-spacing:.2px}
  label{display:block;font-weight:700;margin:8px 0 6px}
  input,textarea{width:100%;padding:12px;border:1px solid #e2e2e2;border-radius:12px;font-size:16px;background:#fff}
  input:focus,textarea:focus{outline:none;border-color:var(--green-600);box-shadow:0 0 0 3px rgba(27,122,78,.12)}
  textarea{min-height:90px}
  .switch{display:flex;gap:14px;background:#f5f7f6;border-radius:24px;padding:8px 12px;margin-top:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;background:var(--green-600)}
  .btn.alt{background:#3a7bd5}
  .btn.gray{background:#888}
  .btn.green{background:#23935c}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:right;vertical-align:top}
  th{background:#f7faf8;position:sticky;top:0}
  #teacher-panel{display:none}
  #login-box{display:none}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px; border:1px solid #cfe7db; color:#0d513b; background:#e9f6ef}
</style>
</head>
<body>

<header class="madina">
  <div class="brand">
        <img src="logo.png" class="logo" alt="شعار حلقات المسجد النبوي">
    <h1>حلقات المسجد النبوي الشريف</h1>
    <p class="subtitle">لحفظ القرآن الكريم والمتون العلمية</p>
  </div>
</header>

<main>

    <div class="card toolbar">
    <div>
      <span class="muted">الوقت الآن (مكة): </span><span id="now" class="badge">--:--:--</span>
      <span id="gate" class="badge" style="margin-inline-start:8px">الحالة: —</span>
    </div>
    <div class="row">
      <button id="btnShowLogin" class="btn alt">دخول المعلّم</button>
      <button id="btnLogout" class="btn" style="display:none;background:#b34b57">خروج</button>
    </div>
  </div>

    <section id="student-form" class="card">
    <h2>تحضير الطالب</h2>
    <form id="form" autocomplete="off">
      <label>١) اسم الطالب</label>
      <input id="name" required placeholder="مثال: أحمد بن خالد"/>

      <label>٢) مقدار الحفظ</label>
      <input id="hifz" required placeholder="مثال: سورة الكهف ١–١١"/>

      <label>٣) المراجعة</label>
      <input id="mur" required placeholder="مثال: نصف جزء عم"/>

      <label>٤) هل تم الاستماع إلى الشيخ؟</label>
      <div class="switch">
        <label><input type="radio" name="listened" value="نعم" required> نعم</label>
        <label><input type="radio" name="listened" value="لا"> لا</label>
      </div>

      <label>ملاحظات (اختياري)</label>
      <textarea id="notes" placeholder="أي ملاحظات للمعلم…"></textarea>

      <div class="row" style="margin-top:12px">
        <button type="submit" class="btn">إرسال للمعلّم</button>
        <span id="ok" class="muted" style="color:#23935c;display:none">تم الحفظ بنجاح</span>
        <span id="err" class="muted" style="color:#c0392b;display:none"></span>
      </div>
      <p class="muted" style="margin:10px 0 0">النافذة المسموحة: ٤:٠٠–٦:٠٠ فجراً (بتوقيت مكة)</p>
    </form>
  </section>

    <section id="login-box" class="card">
    <h2>تسجيل دخول المعلّم</h2>
    <div class="row">
      <input id="email" type="email" placeholder="بريد المعلّم">
      <input id="password" type="password" placeholder="كلمة المرور">
      <button id="btnLogin" class="btn alt">دخول</button>
    </div>
    <div id="lerr" class="muted" style="color:#c0392b;margin-top:8px"></div>
  </section>

    <section id="teacher-panel" class="card">
    <h2>لوحة المعلّم</h2>
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="row">
        <label>من: <input id="from" type="date"></label>
        <label>إلى: <input id="to" type="date"></label>
        <button id="btnFilter" class="btn alt">تصفية</button>
        <button id="btnToday" class="btn gray">اليوم</button>
        <button id="btnLast7" class="btn gray">آخر 7 أيام</button>
      </div>
      <div class="row">
        <button id="btnExport" class="btn green">تصدير CSV</button>
      </div>
    </div>
    <p class="muted" id="count"></p>
    <div style="overflow:auto;max-height:70vh">
      <table id="tbl">
        <thead>
          <tr><th>التاريخ (مكة)</th><th>الاسم</th><th>الحفظ</th><th>المراجعة</th><th>الاستماع</th><th>ملاحظات</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<script>
/* ==== استبدلي بقيم مشروعك في Supabase ==== */
const SUPABASE_URL       = 'https://pgroyirpumfnqgesmdhs.supabase.co';      // Project URL
const SUPABASE_ANON_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBncm95aXJwdW1mbnFnZXNtZGhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzgxNjUsImV4cCI6MjA3MzIxNDE2NX0.nFMHjwDyIgT140by2o6Y-N38Iugl6lImIGUM7fZARF4';          // anon public key
/* ========================================== */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* الوقت بتوقيت مكة + نافذة 4-6 فجراً */
const TZ='Asia/Riyadh', START_H=4, END_H=6;
function nowStr(){return new Intl.DateTimeFormat('ar-SA',{timeZone:TZ,hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());}
function hourKSA(){return parseInt(new Intl.DateTimeFormat('en-GB',{timeZone:TZ,hour12:false,hour:'2-digit'}).format(new Date()),10);}
function isOpen(){const h=hourKSA(); return h>=START_H && h<END_H;}
const $now=document.getElementById('now'), $gate=document.getElementById('gate');
setInterval(()=>{ $now.textContent=nowStr(); $gate.textContent='الحالة: '+(isOpen()?'مفتوح':'مغلق'); },1000);

/* عناصر الواجهة */
const $studentForm=document.getElementById('student-form');
const $loginBox=document.getElementById('login-box');
const $teacher=document.getElementById('teacher-panel');
const $btnShowLogin=document.getElementById('btnShowLogin');
const $btnLogout=document.getElementById('btnLogout');

/* إظهار صندوق دخول المعلّم */
$btnShowLogin.onclick=()=>{ $loginBox.style.display='block'; window.scrollTo({top:$loginBox.offsetTop,behavior:'smooth'}); };

/* دخول/خروج المعلّم */
document.getElementById('btnLogin').onclick = async ()=>{
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const {error}=await sb.auth.signInWithPassword({email,password});
  const lerr=document.getElementById('lerr');
  if(error){ lerr.textContent=error.message; return; }
  lerr.textContent=''; onTeacherSignedIn();
};
$btnLogout.onclick = async ()=>{ await sb.auth.signOut(); onTeacherSignedOut(); };

function onTeacherSignedIn(){
  $studentForm.style.display='none';
  $loginBox.style.display='none';
  $teacher.style.display='block';
  $btnLogout.style.display='inline-flex';
  loadRows();
}
function onTeacherSignedOut(){
  $studentForm.style.display='block';
  $loginBox.style.display='none';
  $teacher.style.display='none';
  $btnLogout.style.display='none';
}

/* التحقق من جلسة حالية */
sb.auth.getSession().then(({data})=>{
  if(data.session){ onTeacherSignedIn(); } else { onTeacherSignedOut(); }
});

/* إرسال الطالب */
document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const ok=document.getElementById('ok'), err=document.getElementById('err'); ok.style.display='none'; err.style.display='none';
  if(!isOpen()){ err.textContent='النموذج يعمل فقط ٤–٦ فجراً (بتوقيت مكة).'; err.style.display='inline'; return; }
  const name=document.getElementById('name').value.trim();
  const hifz=document.getElementById('hifz').value.trim();
  const mur =document.getElementById('mur').value.trim();
  const notes=document.getElementById('notes').value.trim();
  const listened=((new FormData(e.target)).get('listened')==='نعم');
  if(!name||!hifz||!mur){ err.textContent='أكمل الحقول المطلوبة.'; err.style.display='inline'; return; }
  const { error } = await sb.from('attendance').insert([{ name,hifz,mur,listened,notes }]);
  if(error){ err.textContent='تعذّر الإرسال: '+error.message; err.style.display='inline'; }
  else { ok.style.display='inline'; e.target.reset(); }
});

/* لوحة المعلّم: قراءة/تصفية/تصدير */
function ksa(dt){ return new Date(dt).toLocaleString('ar-SA',{timeZone:TZ,hour12:false}); }
async function loadRows(range){
  let q = sb.from('attendance').select('*').order('created_at',{ascending:false});
  if(range?.from){ q=q.gte('created_at', range.from+'T00:00:00Z'); }
  if(range?.to){   q=q.lte('created_at', range.to  +'T23:59:59Z'); }
  const { data, error } = await q; if(error){ alert('تعذّر الجلب: '+error.message); return; }
  document.getElementById('count').textContent=`عدد السجلات: ${data.length}`;
  const tbody=document.querySelector('#tbl tbody');
  tbody.innerHTML=data.map(r=>`
    <tr><td>${ksa(r.created_at)}</td><td>${esc(r.name)}</td><td>${esc(r.hifz)}</td>
        <td>${esc(r.mur)}</td><td>${r.listened?'نعم':'لا'}</td><td>${esc(r.notes||'')}</td></tr>
  `).join('');
  window.__rows=data;
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

document.getElementById('btnFilter').onclick = ()=>{
  const from=document.getElementById('from').value || null;
  const to  =document.getElementById('to').value   || null;
  loadRows({from,to});
};
document.getElementById('btnToday').onclick = ()=>{
  const t=new Date().toISOString().slice(0,10);
  document.getElementById('from').value=t; document.getElementById('to').value=t;
  loadRows({from:t,to:t});
};
document.getElementById('btnLast7').onclick = ()=>{
  const to=new Date(); const from=new Date(Date.now()-6*86400000);
  const s=d=>d.toISOString().slice(0,10);
  document.getElementById('from').value=s(from); document.getElementById('to').value=s(to);
  loadRows({from:s(from),to:s(to)});
};
document.getElementById('btnExport').onclick = ()=>{
  const rows=(window.__rows||[]).map(r=>[ksa(r.created_at),r.name,r.hifz,r.mur,r.listened?'نعم':'لا',r.notes||'']);
  const header=['التاريخ','الاسم','الحفظ','المراجعة','الاستماع','ملاحظات'];
  const csv=[header,...rows].map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='attendance.csv'; a.click();
};
</script>
</body>
</html>
